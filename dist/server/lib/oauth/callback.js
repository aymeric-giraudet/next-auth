"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _client=_interopRequireDefault(require("./client")),_querystring=_interopRequireDefault(require("querystring")),_jwtDecode=_interopRequireDefault(require("jwt-decode"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var _default=function(){var a=_asyncToGenerator(function*(a,b,c){var{oauth_token:d,oauth_verifier:e,code:f}=a.query,g=(0,_client.default)(b);if(b.version&&b.version.startsWith("2.")){if("POST"===a.method){var h=JSON.parse(JSON.stringify(a.body));f=h.code}Object.prototype.hasOwnProperty.call(b,"useAuthTokenHeader")?g.useAuthorizationHeaderforGET(b.useAuthTokenHeader):g.useAuthorizationHeaderforGET(!0),g.getOAuthAccessToken=_getOAuthAccessToken,yield g.getOAuthAccessToken(f,b,(a,d,e,h)=>{(a||h.error)&&console.error("GET_OAUTH2_ACCESS_TOKEN_ERROR",a,h,b.id,f),"apple"===b.id?_decodeIDToken(b,d,e,h.id_token,(a,f)=>c(a,_getProfile(a,f,d,e,b))):(g.get=_get,g.get(b,d,(a,f)=>c(a,_getProfile(a,f,d,e,b))))})}else yield g.getOAuthAccessToken(d,null,e,(a,d,e,f)=>{(a||f.error)&&console.error("GET_OAUTH_ACCESS_TOKEN_ERROR",a,f),g.get(b.profileUrl,d,e,(a,f)=>c(a,_getProfile(a,f,d,e,b)))})});return function(){return a.apply(this,arguments)}}();exports.default=_default;function _getProfile(){return _getProfile2.apply(this,arguments)}function _getProfile2(){return _getProfile2=_asyncToGenerator(function*(a,b,c,d,e){a&&console.error("GET_OAUTH_PROFILE_ERROR",a);var f={};try{("string"==typeof b||b instanceof String)&&(b=JSON.parse(b)),f=yield e.profile(b)}catch(a){throw console.error("PARSE_OAUTH_PROFILE_ERROR",a),new Error("Failed to get OAuth profile")}return{profile:{name:f.name,email:f.email?f.email.toLowerCase():null,image:f.image},account:{provider:e.id,type:e.type,id:f.id,refreshToken:d,accessToken:c,accessTokenExpires:null},_profile:b}}),_getProfile2.apply(this,arguments)}function _getOAuthAccessToken(){return _getOAuthAccessToken2.apply(this,arguments)}function _getOAuthAccessToken2(){return _getOAuthAccessToken2=_asyncToGenerator(function*(a,b,c){var d=b.accessTokenUrl,e=null===b.setGetAccessTokenAuthHeader||b.setGetAccessTokenAuthHeader,f=_objectSpread({},b.params)||{},g=_objectSpread({},b.headers)||{},h="refresh_token"===f.grant_type?"refresh_token":"code";f[h]||(f[h]=a),f.client_id||(f.client_id=b.clientId),f.client_secret||(b.clientSecretCallback?f.client_secret=yield b.clientSecretCallback(b.clientSecret):f.client_secret=b.clientSecret),f.redirect_uri||(f.redirect_uri=b.callbackUrl),g["Content-Type"]||(g["Content-Type"]="application/x-www-form-urlencoded"),g["Client-ID"]||(g["Client-ID"]=b.clientId),e&&!g.Authorization&&(g.Authorization="Bearer ".concat(a));var i=_querystring.default.stringify(f);this._request("POST",d,g,i,null,(a,b,d)=>{if(a)return console.error("_GET_OAUTH_ACCESS_TOKEN_ERROR",a,b,d),c(a);var f;try{f=JSON.parse(b)}catch(a){f=_querystring.default.parse(b)}var g=f.access_token,h=f.refresh_token;c(null,g,h,f)})}),_getOAuthAccessToken2.apply(this,arguments)}function _get(a,b,c){var d=a.profileUrl,e=a.headers||{};this._useAuthorizationHeaderForGET&&(e.Authorization=this.buildAuthHeader(b),e["Client-ID"]=a.clientId,b=null),this._request("GET",d,e,null,b,c)}function _decodeIDToken(a,b,c,d,e){if(!d)throw new Error("Missing idToken");var f=(0,_jwtDecode.default)(d),g=JSON.stringify(f);e(null,g,b,c,a)}