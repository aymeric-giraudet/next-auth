"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _crypto=require("crypto"),_jsonwebtoken=_interopRequireDefault(require("jsonwebtoken")),_errors=require("../../lib/errors");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var _default=function(){var a=_asyncToGenerator(function*(a,b,c,d){try{if(!b)throw new Error("Missing profile");if(!c||!c.id||!c.type)throw new Error("Missing or invalid provider account");var{adapter:e,jwt:f,jwtSecret:g,sessionMaxAge:h}=d,{createUser:i,getUser:j,getUserByProviderAccountId:k,getUserByEmail:l,linkAccount:m,createSession:n,getSession:o,deleteSession:p}=yield e.getAdapter(d),q=null,r=null,s=null,t=!1;if(a)if(f)try{var u=_jsonwebtoken.default.verify(a,g,{maxAge:h});q=u.nextauth||null,q&&q.user&&q.user.id&&(r=yield j(q.user.id),s=!!r)}catch(a){}else q=yield o(a),q&&q.userId&&(r=yield j(q.userId),s=!!r);if("email"===c.type){if(!b.email)throw new _errors.InvalidProfile;var v=yield l(b.email);if(!v)r=yield i(b),t=!0;else if(s){if(r.id===v.id)return{session:q,user:r,isNewUser:t};f||(yield p(a)),r=v}else r=v;return q=f?yield createJwtSession(r,h):yield n(r),{session:q,user:r,isNewUser:t}}if("oauth"===c.type){var w=yield k(c.provider,c.id);if(!w){if(s)return yield m(r.id,c.provider,c.type,c.id,c.refreshToken,c.accessToken,c.accessTokenExpires),{session:q,user:r,isNewUser:t};var x=yield l(b.email);if(x)throw new _errors.AccountNotLinkedError;else{if(!s&&!b.email)throw new _errors.InvalidProfile;return r=yield i(b),yield m(r.id,c.provider,c.type,c.id,c.refreshToken,c.accessToken,c.accessTokenExpires),q=f?yield createJwtSession(r,h):yield n(r),t=!0,{session:q,user:r,isNewUser:t}}}else if(s){if("".concat(w.id)==="".concat(r.id))return{session:q,user:r,isNewUser:t};throw new _errors.AccountNotLinkedError}else return q=f?yield createJwtSession(w,h):yield n(w),{session:q,user:w,isNewUser:t}}else return Promise.reject(new Error("Provider not supported"))}catch(a){return Promise.reject(a)}});return function(){return a.apply(this,arguments)}}();exports.default=_default;var createJwtSession=function(){var a=_asyncToGenerator(function*(a,b){var c=new Date;c.setTime(c.getTime()+b);var d=c.toISOString();return Promise.resolve({user:a,sessionExpires:d,accessToken:(0,_crypto.randomBytes)(32).toString("hex")})});return function(){return a.apply(this,arguments)}}();