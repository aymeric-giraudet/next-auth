"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _crypto=require("crypto"),_cookie=_interopRequireDefault(require("./lib/cookie")),_callbackUrlHandler=_interopRequireDefault(require("./lib/callback-url-handler")),_providers=_interopRequireDefault(require("./lib/providers")),_providers2=_interopRequireDefault(require("./routes/providers")),_signin=_interopRequireDefault(require("./routes/signin")),_signout=_interopRequireDefault(require("./routes/signout")),_callback=_interopRequireDefault(require("./routes/callback")),_session=_interopRequireDefault(require("./routes/session")),_pages=_interopRequireDefault(require("./pages")),_adapters=_interopRequireDefault(require("../adapters"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var DEFAULT_SITE="",DEFAULT_BASE_PATH="/api/auth",_default=function(){var a=_asyncToGenerator(function*(a,b,c){return new Promise(function(){var d=_asyncToGenerator(function*(d){var e,f=d,{url:g,query:h,body:i}=a,{slug:j,nextauth:l=j,action:m=l[0],provider:n=l[1],error:k}=h,{csrfToken:o}=i,p=c.site||DEFAULT_SITE,q=c.basePath||DEFAULT_BASE_PATH,r="".concat(p).concat(q);if(c.adapter)e=c.adapter;else if(c.database)e=_adapters.default.Default(c.database);else return console.error("Error:\n","NextAuth requires a 'database' or 'adapter' option to be specified.\n","See documentation for details https://next-auth.js.org"),_pages.default.render(a,b,"error",{site:p,error:"Configuration",baseUrl:r},f),f();var s,t=c.useSecureCookies||r.startsWith("https://"),u=t?"__Secure-":"",v=_objectSpread({sessionToken:{name:"".concat(u,"next-auth.session-token"),options:{httpOnly:!0,sameSite:"lax",path:"/",secure:t}},callbackUrl:{name:"".concat(u,"next-auth.callback-url"),options:{sameSite:"lax",path:"/",secure:t}},baseUrl:{name:"".concat(u,"next-auth.base-url"),options:{httpOnly:!0,sameSite:"lax",path:"/",secure:t}},csrfToken:{name:"".concat(t?"__Host-":"","next-auth.csrf-token"),options:{httpOnly:!0,sameSite:"lax",path:"/",secure:t}}},c.cookies),w=c.secret||(0,_crypto.createHash)("sha256").update(JSON.stringify(c)).digest("hex"),x=!1;if(a.cookies[v.csrfToken.name]){var[B,C]=a.cookies[v.csrfToken.name].split("|");C===(0,_crypto.createHash)("sha256").update("".concat(B).concat(w)).digest("hex")&&(s=B,"POST"===a.method&&s===o&&(x=!0))}if(!s){s=(0,_crypto.randomBytes)(32).toString("hex");var D="".concat(s,"|").concat((0,_crypto.createHash)("sha256").update("".concat(s).concat(w)).digest("hex"));_cookie.default.set(b,v.csrfToken.name,D,v.csrfToken.options)}var y=!0;if(a.cookies[v.baseUrl.name]){var[E,F]=a.cookies[v.baseUrl.name].split("|");E===r&&F===(0,_crypto.createHash)("sha256").update("".concat(E).concat(w)).digest("hex")&&(y=!1)}if(y){var G="".concat(r,"|").concat((0,_crypto.createHash)("sha256").update("".concat(r).concat(w)).digest("hex"));_cookie.default.set(b,v.baseUrl.name,G,v.baseUrl.options)}var z=_objectSpread(_objectSpread({jwt:!1,jwtSecret:w,sessionMaxAge:2592000000,sessionUpdateAge:86400000,verificationMaxAge:86400000,debug:!1,pages:{}},c),{},{adapter:e,site:p,basePath:q,baseUrl:r,action:m,provider:n,cookies:v,secret:w,csrfToken:s,csrfTokenVerified:x,providers:(0,_providers.default)(c.providers,r),callbackUrl:p});z.callbackUrl=yield(0,_callbackUrlHandler.default)(a,b,z);var A=a=>(b.status(302).setHeader("Location",a),b.end(),f());if("GET"===a.method)switch(m){case"providers":(0,_providers2.default)(a,b,z,f);break;case"session":(0,_session.default)(a,b,z,f);break;case"csrf":return b.json({csrfToken:s}),f();case"signin":if(n&&z.providers[n])(0,_signin.default)(a,b,z,f);else{if(z.pages.signin)return A("".concat(z.pages.signin).concat(z.pages.signin.includes("?")?"&":"?","callbackUrl=").concat(z.callbackUrl));_pages.default.render(a,b,"signin",{site:p,providers:Object.values(z.providers),callbackUrl:z.callbackUrl,csrfToken:s},f)}break;case"signout":if(z.pages.signout)return A("".concat(z.pages.signout).concat(z.pages.signout.includes("?")?"&":"?","callbackUrl=").concat(z.callbackUrl));_pages.default.render(a,b,"signout",{site:p,baseUrl:r,csrfToken:s,callbackUrl:z.callbackUrl},f);break;case"callback":if(n&&z.providers[n])(0,_callback.default)(a,b,z,f);else return b.status(400).end("Error: HTTP GET is not supported for ".concat(g)),f();break;case"verify-request":if(z.pages.verifyRequest)return A(z.pages.verifyRequest);_pages.default.render(a,b,"verify-request",{site:p},f);break;case"error":if(z.pages.error)return A("".concat(z.pages.error).concat(z.pages.error.includes("?")?"&":"?","error=").concat(k));_pages.default.render(a,b,"error",{site:p,error:k,baseUrl:r},f);break;default:return b.status(404).end(),f();}else if("POST"===a.method)switch(m){case"signin":if(n&&z.providers[n]){(0,_signin.default)(a,b,z,f);break}break;case"signout":(0,_signout.default)(a,b,z,f);break;case"callback":if(n&&z.providers[n])(0,_callback.default)(a,b,z,f);else return b.status(400).end("Error: HTTP POST is not supported for ".concat(g)),f();break;default:return b.status(400).end("Error: HTTP POST is not supported for ".concat(g)),f();}else return b.status(400).end("Error: HTTP ".concat(a.method," is not supported for ").concat(g)),f()});return function(){return d.apply(this,arguments)}}())});return function(){return a.apply(this,arguments)}}();exports.default=_default;